---
title: "[gGnome](https://github.com/mskilab/gGnome) Tutorial"
author: "Marcin Imielinski Laboratory"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

<style type="text/css">
body, td {
   font-size: 16px;
}
pre code, pre, code {
  font-size: 15px;
  color: rgb(20, 20, 20);
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}

h1{
  font-size: 22pt;
  }

h2{
  font-size: 20pt;
  }

h3{
  font-size: 16pt;
  }


</style>

```{r, setup,echo=FALSE,cache=TRUE}
## knitr::opts_chunk$set(collapse = TRUE)
knitr::opts_chunk$set(fig.width = 8, collapse = TRUE, cache = TRUE, warning = FALSE, echo = FALSE, results = "hide", message = FALSE)
library(gTrack)
library(rtracklayer)
library(kableExtra)
library(magrittr)
library(tidyr)
library(gGnome)
```

# Applications
## Classifying SV events
There are many mutagenesis pathways producing various patterns of SVs in the cancer genomes. By identifying the specific motif that are recurrent in the cancer genoem graphs, we can classify subgraphs that satisfy the set of criteria corresponding to a particular class. These classes range from simple like deletions and tandem duplications, to complex like chromothripsis and breakage-fusion-bridge cycles. As of [Hadi et al, Cell 2020](https://www.biorxiv.org/content/10.1101/836296v2), we support the identification of 5 simple event and 8 complex:

* simple
    + Deletion (del)
    + Tandem duplication (dup)
    + Inversion (inv)
    + Inverted duplication (invdup)
    + Translocations (tra)
* complex
    + Rigma
    + Pyrgo
    + Templated insertion chains (tic)
    + Chromoplexy
    + Chromothripsis
    + Breakage-fusion-bridge cycles (bfb)
    + Double minute (dm)
    + Tyfonas

For ease of use, all the callers are wrapped into a single function `events`:

```{r, events, warning = FALSE, cache = TRUE, fig.width = 8, collapse = TRUE, cache = TRUE, warning = FALSE, echo = FALSE, results = "hide", message = FALSE}
## verbose=FALSE whenever possible
## load the graph for HCC1954
hcc1954 = gG(jabba = system.file("extdata", "hcc1954", "jabba.rds", package = "gGnome"))

## Identify all supported SV event types
hcc1954 = events(hcc1954, verbose = FALSE)

## Summary of identified events
hcc1954$meta$event[, table(type)]

## plot the locus of a BFB event
plot(hcc1954$gt, hcc1954[bfb>0]$footprint + 1e6)

## for the following examples load the CCLE models
ccle = dir(system.file("extdata", package = "gGnome"), ".+jabba.simple.rds", full = TRUE)
names(ccle) = gsub(".*gGnome/[inst/]?extdata/(.*)\\.jabba\\.simple\\.rds$", "\\1", ccle)
ggs = lapply(setNames(names(ccle), names(ccle)), function(nm){
  gg = gG(jabba = ccle[nm])
  gg$set(name = nm)
  ## gg = events(gg, verbose = FALSE)
  message("Processed ", nm)
  return(gg)
})

# ccle.ev = rbindlist(lapply(names(ccle), function(nm){  
#   out = ggs[[nm]]$meta$event[, ":="(sample = nm)]
#   return(out)
# }), fill = TRUE)[, .(sample, type, ev.id, footprint)]

```

Below we describe each function in detail. We start from the 

### Deletions and Rigma
When simple deletions accumulate in the same locus more than expected from a null distribution (explained below), their cluster is labeled rigma.

```{r, deletions and rigma, warning = FALSE}
hcc1954 = del(hcc1954)
plot(hcc1954$gt, hcc1954$meta$rigma$footprint %>% GRanges %>% streduce(5e5))
```

### Tandem duplications and pyrgo
Similar to deletions and rigma, when a particular genomic region attain more than expected tandem duplications, the cluster of duplications is classified as a pyrgo.

```{r, duplications and pyrgo, warning = FALSE}
mfe280 = gG(jabba = system.file("extdata", "MFE_280.jabba.simple.rds", package = "gGnome"))
mfe280 = dup(mfe280)
plot(mfe280$gt, mfe280$meta$pyrgo$footprint %>% head(3) %>% GRanges %>% streduce(5e5))
```

### Chromothripsis
Chromothripsis has been a stereotypical example of complex SV event, since its inception in [Stephens et al., Cell 2011](https://doi.org/10.1016/j.cell.2010.11.055), in which it is proposed to originate from a single catastrophic shattering of a relatively focused chromosome region (e.g. arm), then randomly ligated by DNA repair pathway, resulting in high numbers of junctions clustered, and oscillating copy numbers due to the random loss/retention of DNA shards. 

```{r, chromothripsis, warning = FALSE}
h2081 = ggs[["NCI_H2081"]]
h2081 = chromothripsis(h2081)
plot(h2081$gt, streduce(h2081$gr %Q% which(chromothripsis>0), 1e6))
```

### Complex amplicons (bfb, dm, tyfonas)
Long has been known that genomic amplifications can drive carcinogenesis, yet the characterization of the exact structures beyond the increase in dosage are limited. Two mechanisms are well known, double minute (DM, also known as extrachromosomal circular DNA, eccDNA) and breakage-fusion-bridge cycles (BFBC). Genome graphs provides an oppurtunity to systematically differentiate and discover the spectrum of amplicon structures. In Hadi et al., Cell 2020, We describe a genome graph-derived feature space for these subgraphs that contain amplified junctions (JCN>7) and stably clustered into at least 3 classes, two of which correspond to DM and BFBC, but a third class with high numbers of junctions and high numbers of fold-back inversions, which is named *tyfonas* based on its wide reaching, extensively rearranged appearance.

The function `amp` identifies 

```{r, amplicon, warning=FALSE}
colo668 = ggs[["COLO_668"]]
colo668 = amp(colo668)
plot(colo668$gt, streduce(colo668$gr %Q% which(tyfonas>0), 1e6))

hara = ggs[["HARA"]]
plot(hara$gt, streduce(hara$gr %Q% which(bfb>0), 1e6))

# hgc27 = ggs[["HGC_27"]]
# plot(hgc27$gt, streduce(hgc27$gr %Q% which(dm>0), 1e6))

hcc827 = ggs[["HCC827"]]
plot(hcc827$gt, streduce(hcc827$gr %Q% which(dm>0), 1e6))

# kyse410 = ggs[["KYSE_410"]]
# plot(kyse410$gt, streduce(kyse410$gr %Q% which(dm>0), 1e6))
```


### Chromoplexy and TICs
A series of long-range junctions (jumping over >=10Mbp on reference genome) can form a chain-like topology, when two breakends from two adjacent junctions in the chain are close enough to each other (by default <= 10 kbp). You can decide the following arguments:
- `min.span` the 
- `max.dist`
- `min.num`

```{r, cp and tic, warning = FALSE}

```

### Others
We also support identification of other event types, here are some simple examples:
```{r, others, warning = FALSE}

```

### Make your own caller
Besides running our current implemented event callers, `gGnome` serves as a generalized framework for users to write their own event callers. A general template procedure is:
- Filter the nodes/edges of interest by their marginal features, e.g. copy number, width, junction span (reference distance between the breakends), orientations
- Cluster by the node or edge based on graph topologies to get candidate subgraphs
- Summarize a set of features of the candidates

## Interactive visualization
We built `gGnome.js`, an interactive web application written in Javascript, to visualize each 

## Balancing the graphs

## Walk decomposition of (sub)graphs (cont.)
`fitcn` function finds integer CNs for `gWalk` that when added up recapitulate the marginal CN of all nodes and edges in the `gGraph`.

```{r cache=FALSE,warning=FALSE, fig.height=10}

```


### balance, simulate/transplant, long-read/optical mapping for walk decomposition

## Evolution of genome structures from multiple related samples
